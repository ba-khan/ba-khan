{% extends 'home.html' %}

{% load static %}

{% block title %}Curriculum MINEDUC{% endblock %}

{% block body2 %}

<script src="{% static 'js/editablegrid.js' %}"></script>
<script src="{% static 'js/editablegrid_renderers.js' %}"></script>
<script src="{% static 'js/editablegrid_editors.js' %}"></script>
<script src="{% static 'js/editablegrid_validators.js' %}"></script>
<script src="{% static 'js/editablegrid_utils.js' %}"></script>
<script src="{% static 'js/editablegrid_charts.js' %}"></script>

<!--<link rel="stylesheet" type="text/css" href="{% static 'css/editablegrid.css'%}">-->

<link rel="stylesheet" type="text/css" href="{% static 'css/superstats.css'%}">

<style>
table.testsched { border-collapse: collapse; border: 1px solid #CCB; width:650px;}
table.testsched td, table.testsched th { padding: 5px; border: 1px solid #E0E0E0;}
table.testsched th { background: #E5E5E5; text-align: left;}
table.testsched th {
    color: #555;
    background-color: #ccc;
    border: 1px solid #bbb;
    text-shadow: 0 1px 0 #eee;
    vertical-align: bottom;
    padding: 5px;
    text-align:center;
}
table.testsched td {
  text-align: left;
}

table.testschedos { border-collapse: collapse; border: 1px solid #CCB; width:650px;table-layout: fixed;}
table.testschedos td, table.testschedos th { padding: 5px; border: 1px solid #E0E0E0;overflow: hidden;}
table.testschedos th { background: #E5E5E5; text-align: left;}
table.testschedos th {
    color: #555;
    background-color: #ccc;
    border: 1px solid #bbb;
    text-shadow: 0 1px 0 #eee;
    vertical-align: bottom;
    padding: 5px;
    text-align:center;
}
table.testschedos td {
  text-align: left;
}
input{
  z-index: 1000;
  width: 100%;
  height: 100%;
}
#popup{
  height:350px;
}
#popuptree{
  height:650px;
}
.ribbon {
  position: relative;
  left: 0px; top: -53px;
  z-index: 1;
  overflow: hidden;
  width: 63px; height: 54px;
  text-align: right;
}
.ribbon span {
  font-size: 9px;
  font-weight: bold;
  color: #FFF;
  text-transform: uppercase;
  text-align: center;
  line-height: 15px;
  transform: rotate(-45deg);
  -webkit-transform: rotate(-45deg);
  width: 97px;
  display: block;
  background: #79A70A;
  background: linear-gradient(#9BC90D 0%, #79A70A 100%);
  box-shadow: 0 3px 10px -5px rgba(0, 0, 0, 1);
  position: absolute;
  top: 13px; left: -25px;
}
.ribbon span::before {
  content: "";
  position: absolute; left: 0px; top: 100%;
  z-index: -1;
  /*border-left: 3px solid #79A70A;
  border-right: 3px solid transparent;
  border-bottom: 3px solid transparent;
  border-top: 3px solid #79A70A;*/
}
.ribbon span::after {
  content: "";
  position: absolute; right: 0px; top: 100%;
  z-index: -1;
  /*border-left: 3px solid transparent;
  border-right: 3px solid #79A70A;
  border-bottom: 3px solid transparent;
  border-top: 3px solid #79A70A;*/
}
#newChapter{
  border: 1px solid #C6D1AD;
    border-radius: 5px;
    display:none; 
    height:220px; 
    padding:15px;
    padding-left: 33%;
    padding-right: 33%;
    text-align: center;
}
#newTopic{
  /*border: 1px solid #C6D1AD;
    border-radius: 5px;
    display:none; */
    height:220px; 
    padding:15px;
    padding-left: 33%;
    padding-right: 33%;
    text-align: center;
}
#newSubtopic{
  /*border: 1px solid #C6D1AD;
    border-radius: 5px;
    display:none; */
    height:220px; 
    padding:15px;
    padding-left: 33%;
    padding-right: 33%;
    text-align: center;
}
#newaccordion{
  border: 1px solid #C6D1AD;
  border-radius: 5px;
  padding:15px;
  padding-left: 10%;
  padding-right: 10%;
  text-align: left;
}
label{
  width: 95px;
}
input{
  margin-bottom: 10px;
}
 
#sidebar {
  margin-right: -1px;
  float: left;
  width: 240px;
    box-sizing: border-box;
   -moz-box-sizing: border-box;
   z-index: 2;
   margin-right: -1px;
}
#sidebar ul {
    margin: 0;
    padding: 0;
    list-style: none;
}
#sidebar ul li {
    margin: 0;
}
#sidebar ul li a {
  margin: 1px 0px 1px 1px;
    padding: 15px 20px;
    font-size: 16px;
    font-weight: 100;
    background: #EEEEEE;
    text-decoration: none;
    display: block;
    border-radius: 10px 1px 1px 10px;
    border: 1px solid #ddd;
    -webkit-transition:  background 0.3s ease-in-out;
    -moz-transition:  background 0.3s ease-in-out;
    -ms-transition:  background 0.3s ease-in-out;
    -o-transition:  background 0.3s ease-in-out;
    transition:  background 0.3s ease-in-out;
    
}
#sidebar ul li a.select{
  border-right: 1px solid #f7f7f7;
  background: #f7f7f7;
  color: #56861f;
  
}
#sidebar ul li:hover a {
    background: #f7f7f7;
    color: #56861f;
}
#sidebar ul li:visited a {
    background: #f7f7f7;
    color: #56861f;
}

.redBackground{
    background-color: gray;  
}

.topictree{
  overflow: hidden;
  overflow-y:scroll;
  height: 550px;
  width: 570px;
  font-size: 12px;
  padding: 5px 10px 10px 0px;
  text-align: left;
  margin: 10px;
  border: 1px solid #ddd;
}

button.accordion {
    background-color: #eee;
    color: #444;
    cursor: pointer;
    padding: 18px;
    width: 100%;
    text-align: left;
    border: none;
    outline: none;
    transition: 0.4s;
}

/* Add a background color to the button if it is clicked on (add the .active class with JS), and when you move the mouse over it (hover) */
button.accordion.active, button.accordion:hover {
    background-color: #ddd;
}

button.accordion:after {
    content: '\02795'; /* Unicode character for "plus" sign (+) */
    font-size: 13px;
    color: #777;
    float: right;
    margin-left: 5px;
}

button.accordion.active:after {
    content: "\2796"; /* Unicode character for "minus" sign (-) */
}

/* Style the accordion panel. Note: hidden by default */
div.panel {
    padding: 0 18px;
    background-color: white;
    display: none;
    overflow: hidden;
    transition: 0.6s ease-in-out;
    opacity: 0;
}

/* The "show" class is added to the accordion panel when the user clicks on one of the buttons. This will show the panel content */
div.panel.show {
    display: block;
    opacity: 1;
}
/*
div.panel {
    padding: 0 18px;
    background-color: white;
    max-height: 0;
    overflow: hidden;
    transition: 0.6s ease-in-out;
    opacity: 0;
}
*/
</style>
<br>
<div class="container">
<div class="main-content">

  <br>
  <h1 style="text-align:center;">Curriculum MINEDUC</h1>
  <div style="width:100%; height:55px;"> <button type='input' id='buttonNewChapter' onclick="javascript:showNewChapter()" style="cursor:pointer; width:200px; height: 35px; padding:8px; float:left; margin-top:10px; margin-right:10px;" class="kui-button kui-button-plain kui-button-primary"><i class="plus"></i> Nuevo Nivel</button> </div>

  <div id="newChapter">
    <form action="" method="post" id="form0">{% csrf_token %}
      <h3>Nuevo Nivel</h3>
      <label for='block'>Nombre: </label><input id="newName" onchange="validar()" onkeyup="validar()" name="name" type="text" class="ui-corner-all placeholder simple-input search-input blur-on-esc" ><br>
      <a onclick='javascript:hideNewChapter()' class="kui-button kui-button-plain kui-button-primary" style="display:inline;cursor:pointer; width:80px; height: 35px; padding:8px; margin-top:10px">Cancelar</a>
      <a onclick='javascript:saveNewChapter()' class="kui-button kui-button-plain kui-button-primary" style="cursor:pointer; width:80px; height: 35px; padding:8px; margin-top:10px">Guardar</a>
    </form>
  </div>
  <!--<div id="newtable">
  </div>!-->
  <div id="newaccordion">
  </div>
  <div id="descargar"><button type="button" class="btn-download" id="button" title="Descargar Planificación" onclick="downloadCurriculum()"></button></div>
</div>
</div>

<div id="popup" style="display:none">
  
</div>

<div id="popuptree" style="display:none">
  
</div>

<script type="text/javascript">

$(document).ready(function(){
    
    $("#hover").click(function(){
          $(this).fadeOut();
      $("#popup").fadeOut();
      $("#popuptree").fadeOut();
      });
    
    $("#close").click(function(){
          $("#hover").fadeOut();
      $("#popup").fadeOut();
      $("#popuptree").fadeOut();
      });

    accordionMineduc();
    var acc = document.getElementsByClassName("accordion");
    var i;

    for (i = 0; i < acc.length; i++) {
        acc[i].onclick = function(){
            this.classList.toggle("active");
            this.nextElementSibling.classList.toggle("show");
        }
    }
  });

  function buscar(){
    var to=false;
    //$('#skill_search').keyup(function () {
      if(to) { clearTimeout(to); }
      to = setTimeout(function () {
        var v = $('#skill_search').val();
        //$('#newTree').jstree(true).search(v);
        $('[id*="newTree"]').jstree(true).search(v);
      }, 250);
    //});
  }
  function downloadCurriculum(){
    console.log('entro en descarga curriculum')
    window.location = "/curriculum/downloadCurriculum";
  }

var arbol = JSON.parse('{{ json_data | escapejs }}');
  function accordionMineduc(){
    //console.log(arbol);
    var newaccordion='';
    var chapters=arbol["capitulos"];
    for (var i = 0; i < chapters.length; i++) {
      //console.log(chapters[i]["nombre"])
      newaccordion += '<button class="accordion">'+chapters[i]["nombre"]+'<a onclick=\'(deleteChapter("'+chapters[i]['id']+'"))\' style="cursor:pointer; width:120px;  padding:0px;left:500px;position:absolute;"><img style="width:25px;height:25px;" src={% static "img/deleteicon.png" %} alt="delete"></a></button><div class="panel">';
      newaccordion += '<a onclick=\'(addTopic("'+chapters[i]['id']+'"))\' style="cursor:pointer; width:200px; height: 35px; padding:8px; " class="kui-button kui-button-plain kui-button-primary">Agregar Unidad</a>';
      newaccordion += '<a onclick=\'(deleteTopic("'+chapters[i]['id']+'"))\' style="cursor:pointer; width:200px; height: 35px; padding:8px; " class="kui-button kui-button-plain kui-button-primary">Eliminar Unidad</a>';
      var topicos = chapters[i]["topico"];
      for (var j = 0; j < topicos.length; j++) {
        newaccordion += '<button class="accordion">'+topicos[j]["nombre"]+'</button><div class="panel">';
        newaccordion += '<a onclick=\'(addSubtopic("'+topicos[j]['id']+'"))\' style="cursor:pointer; width:200px; height: 35px; padding:8px; " class="kui-button kui-button-plain kui-button-primary">Agregar Obj. de Aprendizaje</a>';
        newaccordion += '<a onclick=\'(deleteSubtopic("'+topicos[j]['id']+'"))\' style="cursor:pointer; width:200px; height: 35px; padding:8px; " class="kui-button kui-button-plain kui-button-primary">Eliminar Obj. de Aprendizaje</a>';
        var subtopicos = topicos[j]["subtopico"];
        for (var k = 0; k < subtopicos.length; k++) {
          //subtopicos[i]
          newaccordion += '<button class="accordion">'+subtopicos[k]["nombre"]+'</button><div class="panel">'
          newaccordion += '<a onclick=\'(addVideoExercise("'+subtopicos[k]['id']+'"))\' style="cursor:pointer; width:200px; height: 35px; padding:8px; " class="kui-button kui-button-plain kui-button-primary">Agregar Ejercicios/Videos</a>';
          newaccordion += '<a onclick=\'(deleteVideoExercise("'+subtopicos[k]['id']+'"))\' style="cursor:pointer; width:200px; height: 35px; padding:8px; " class="kui-button kui-button-plain kui-button-primary">Eliminar Ejercicios/Videos</a>';
          newaccordion += '<p>'+subtopicos[k]['aeoe']+'</p>'
          var ejer = subtopicos[k]["skills"];
          newaccordion += '<button class="accordion">Ejercicios</button><div class="panel">';
          for (var m = 0; m < ejer.length; m++) {
            //vid[l]
           // console.log(ejer[m]["skill"])
            newaccordion += '<img src={% static "img/ejercicios.png" %} alt="ejercicios"><a href="'+ejer[m]["url"]+'" target="_blank">'+ejer[m]["nombre"]+'</a><br>';
            //newaccordion += '<li><a href="'+vid[l]["url"]+'" target="_blank">'+vid[l]["nombre"]+'</a></li><br>'
          }
          newaccordion += '</div>';
          var vid = subtopicos[k]["videos"];
          newaccordion += '<button class="accordion">Videos</button><div class="panel">';
          for (var l = 0; l < vid.length; l++) {
            //vid[l]
           // console.log(vid[l]["video"])
            newaccordion += '<img src={% static "img/videos.png" %} alt="videos"><a href="'+vid[l]["url"]+'" target="_blank">'+vid[l]["nombre"]+'</a><br>';
            //newaccordion += '<li><a href="'+vid[l]["url"]+'" target="_blank">'+vid[l]["nombre"]+'</a></li><br>'
            $('#newTree'+subtopicos[k]["id"]).jstree('select_node', vid[l]["video"]);
          }
          newaccordion += '</div>';
          newaccordion += '</div>';
        }
        newaccordion += '</div>'
      }
      newaccordion+='</div>';
    }
    $('#newaccordion').append(newaccordion);
  }


  $('#curriculum').addClass('active selected');

  function showNewChapter(){
  $('#newChapter').toggle('blind',10);
  $('#buttonNewChapter').hide();
  }

  function hideNewChapter(){
  $('#newChapter').toggle('blind',10);
  $('#buttonNewChapter').show();
  }

  function showNewTopic(){
  $('#newTopic').toggle('blind',10);
  $('#buttonNewTopic').hide();
  }

  function hideNewTopic(){
  $('#popup').hide();
  $('#hover').hide();
  }

  function showNewSubtopic(){
  $('#newSubtopic').toggle('blind',10);
  $('#buttonNewSubtopic').hide();
  }

  function hideNewSubtopic(){
  $('#popup').hide();
  $('#hover').hide();
  }

  function hideTree(){
  $('#popuptree').hide();
  $('#hover').hide();
  }

  function saveNewChapter(){
  if(validar()){
    $.ajax({
    url: "{% url 'curriculum:nuevo_chapter' %}",
    type: "POST",
    data: $("#form0").serialize(),
      success: function(response){
        $("#popup").empty()
        $("#close").hide();
        $("#hover").fadeIn();
        $("#popup").fadeIn();
        $("#popup").append("<p class='response'>"+response+"</p>");
        auxResponse = response;
        if (auxResponse == "Nivel guardado correctamente"){
          $("#hover").css('pointer-events','none');
          $("#close").css('pointer-events','none');
          window.setTimeout(function(){location.reload()},1000);
        }
      }
    });
  }else{
    $("#popup").empty()
    $("#hover").fadeIn().css('display', '');
    $("#popup").fadeIn().css('display', '');
    $("#popup").append("<p class='response'>Revise los campos ingresados</p>");
  }
}

function saveNewTopic(t){
  var nombretopic = $('#newNameTopic').val()
  if(validarTopic()){
    $.ajax({
      url: "{% url 'curriculum:nuevo_topic' %}",
      type: "POST",
      data: {nombre: nombretopic, curso: t},
        success: function(response){
          $("#popup").empty()
          $("#close").hide();
          $("#hover").fadeIn();
          $("#popup").fadeIn();
          $("#popup").append("<p class='response'>"+response+"</p>");
          auxResponse = response;
          if (auxResponse == "Unidad guardada correctamente"){
            $("#hover").css('pointer-events','none');
            $("#close").css('pointer-events','none');
            window.setTimeout(function(){location.reload()},1000);
          }        }
    });
  }
  else{
    $("#popup").empty()
    $("#hover").fadeIn().css('display', '');
    $("#popup").fadeIn().css('display', '');
    $("#popup").append("<p class='response'>Revise los campos ingresados</p>");
  }
}


function saveNewSubtopic(t){
  var nombresubtopic = $('#newNameSubtopic').val()
  var descripcionsubtopic = $('#textarea_coment').val()
  //console.log(descripcionsubtopic);
  if(validarSubtopic()){
    $.ajax({
      url: "{% url 'curriculum:nuevo_subtopic' %}",
      type: "POST",
      data: {nombre: nombresubtopic, curso: t, descripcion: descripcionsubtopic},
        success: function(response){
          $("#popup").empty()
          $("#close").hide();
          $("#hover").fadeIn();
          $("#popup").fadeIn();
          $("#popup").append("<p class='response'>"+response+"</p>");
          auxResponse = response;
          if (auxResponse == "Objetivo de Aprendizaje guardado correctamente"){
            $("#hover").css('pointer-events','none');
            $("#close").css('pointer-events','none');
            window.setTimeout(function(){location.reload()},1000);
          }        
        }
    });
  }
  else{
    $("#popup").empty()
    $("#hover").fadeIn().css('display', '');
    $("#popup").fadeIn().css('display', '');
    $("#popup").append("<p class='response'>Revise los campos ingresados</p>");
  }
}

function saveVideoExercise(t){
  var infodata=[]
  var cont=0;
  var select = $("#newTree"+t).jstree("get_selected", true);
  for (var i = 0; i < select.length; i++) {
    if (typeof select[i]["data"] != "undefined"){
      if(select[i]["data"]["skill_id"]){
        infodata[cont]={"id":select[i]["id"],"id_sv":select[i]["data"]["skill_id"], "icon":select[i]["icon"]}
      }
      else{
        infodata[cont]={"id":select[i]["id"],"id_sv":select[i]["data"]["video_id"], "icon":select[i]["icon"]}
      }

    }

    cont++;
  }

  if (select.length>0){
    $.ajax({
    url: "{% url 'curriculum:save_videoexercise' %}",
    type: "POST",
    data: {infodata, subtopic:t},
      success: function(response){
        $('#popuptree').hide();
        $("#popup").empty()
        $("#close").hide();
        $("#hover").fadeIn();
        $("#popup").fadeIn();
        $("#popup").append("<p class='response'>"+response+"</p>");
        auxResponse = response;
        if (auxResponse == "Ejercicios y/o Videos guardados correctamente"){
          $("#hover").css('pointer-events','none');
          $("#close").css('pointer-events','none');
          window.setTimeout(function(){location.reload()},1000);
        }    
      }
    });
  }
  else{
    console.log('faltan datos por elegir');
  }
}

function addTopic(id){
  $('#popup').empty();
  $('#hover').fadeIn();
  $('#popup').fadeIn();
  $('#popup').append("<div id='newTopic'><form action='' method='post' id='form1'>{% csrf_token %}<h3>Nueva Unidad</h3><label for='block'>Unidad: </label><input id='newNameTopic' onchange='validar()' onkeyup='validar()' name='nameTopic' type='text' class='ui-corner-all placeholder simple-input search-input blur-on-esc' ><br><a onclick='javascript:hideNewTopic()' class='kui-button kui-button-plain kui-button-primary' style='display:inline;cursor:pointer; width:80px; height: 35px; padding:8px; margin-top:10px'>Cancelar</a><a onclick=\"(saveNewTopic('" + id + " '))\" class='kui-button kui-button-plain kui-button-primary' style='cursor:pointer; width:80px; height: 35px; padding:8px; margin-top:10px'>Guardar</a></form></div>");
}

function addSubtopic(id){
  $('#popup').empty();
  $('#hover').fadeIn();
  $('#popup').fadeIn();
  $('#popup').append("<div id='newSubtopic'><form action='' method='post' id='form2'>{% csrf_token %}<h3>Nuevo Objetivo de Aprendizaje o Aprendizaje Esperado</h3><label for='block'>Número: </label><input id='newNameSubtopic' onchange='validar()' onkeyup='validar()' name='nameSubtopic' type='text' class='ui-corner-all placeholder simple-input search-input blur-on-esc' ><br><label for='block'>Descripción: </label><textarea id='textarea_coment' class='ui-corner-all placeholder simple-input search-input blur-on-esc vaciar' style='width:220px;height:50px;padding-top:5px'></textarea><br><a onclick='javascript:hideNewSubtopic()' class='kui-button kui-button-plain kui-button-primary' style='display:inline;cursor:pointer; width:80px; height: 35px; padding:8px; margin-top:10px'>Cancelar</a><a onclick=\"(saveNewSubtopic('" + id + " '))\" class='kui-button kui-button-plain kui-button-primary' style='cursor:pointer; width:80px; height: 35px; padding:8px; margin-top:10px'>Guardar</a></form></div>");
}

function addVideoExercise(id){
    var tree = JSON.parse('{{ topictree_json_string | escapejs }}');
    $('#popuptree').empty();
    $('#hover').fadeIn();
    $('#popuptree').fadeIn();
    $('#popuptree').append("<div id='filtrar' style='float:left;width:50%;'><label>Filtrar por: </label><select class='skill_search' onchange='valorfiltro(this, "+id+")'><option value='todos'>Todos</option><option value='ejercicios'>Ejercicios</option><option value='videos'>Videos</option></select></div>")
    $('#popuptree').append("<div id='search' style='float:left;width:50%;'><label for='skill_search'>Buscar: </label><input id='skill_search' type='text' class='ui-corner-all placeholder simple-input search-input blur-on-esc' onkeyup='buscar()'></div>")
    $('#popuptree').append("<div id='newTree"+id+"' class='topictree'></div>")
    $('#newTree'+id+'').jstree(tree);
    $('#popuptree').append("<br><a onclick='javascript:hideTree()' class='kui-button kui-button-plain kui-button-primary' style='display:inline;cursor:pointer; width:80px; height: 35px; padding:8px; margin-top:10px'>Cancelar</a><a onclick=\"(saveVideoExercise('" + id + " '))\" class='kui-button kui-button-plain kui-button-primary' style='cursor:pointer; width:80px; height: 35px; padding:8px; margin-top:10px'>Guardar</a>");
    
    setTimeout(function(){
      var chapters=arbol["capitulos"];
      for (var i = 0; i < chapters.length; i++) {
        var topicos = chapters[i]["topico"];
        for (var j = 0; j < topicos.length; j++) {
          var subtopicos = topicos[j]["subtopico"];
          for (var k = 0; k < subtopicos.length; k++) {
            if (subtopicos[k]['id']==id){
              var ejer = subtopicos[k]["skills"];
              for (var l = 0; l < ejer.length; l++) {
                $('#newTree'+id+'').jstree('select_node', '#'+ejer[l]['idtree']+'');
              }
              var vid = subtopicos[k]["videos"];
              for (var m = 0; m < vid.length; m++) {
                $('#newTree'+id+'').jstree('select_node', '#'+vid[m]['idtree']+'');
              }
            }
          }
        }
      }
    },1000);
}

function valorfiltro(valor, id){
  if(valor.value == "ejercicios"){
    var tree = JSON.parse('{{ topictree_json_string | escapejs }}');
    var info = tree['core']['data'];
    for (var i = 0; i < info.length; i++) {
        if(typeof info[i]['data']!= "undefined" && typeof info[i]['data']['video_id']!= "undefined"){
          delete info[i]
        } 
    }
    try{
      $('#newTree'+id+'').jstree("destroy");
      $('#newTree'+id+'').jstree(tree);
    }
    catch(err){
      $('#newTree'+id+'').jstree(tree);
      console.log(err);
    }
    setTimeout(function(){
      var chapters=arbol["capitulos"];
      for (var i = 0; i < chapters.length; i++) {
        var topicos = chapters[i]["topico"];
        for (var j = 0; j < topicos.length; j++) {
          var subtopicos = topicos[j]["subtopico"];
          for (var k = 0; k < subtopicos.length; k++) {
            if (subtopicos[k]['id']==id){
              var ejer = subtopicos[k]["skills"];
              for (var l = 0; l < ejer.length; l++) {
                $('#newTree'+id+'').jstree('select_node', '#'+ejer[l]['idtree']+'');
              }
            }
          }
        }
      }
    },500);
  }
  if(valor.value == "videos"){
    var tree = JSON.parse('{{ topictree_json_string_video | escapejs }}');
    var info = tree['core']['data'];
    //console.log(info);
    for (var i = 0; i < info.length; i++) {
        if(typeof info[i]['data']!= "undefined" && typeof info[i]['data']['skill_id']!= "undefined"){
          delete info[i]
          //console.log(info[i]['data']);
        } 
    }
    //console.log(info)
    try{
      $('#newTree'+id+'').jstree("destroy");  
      $('#newTree'+id+'').jstree(tree);  
      //$('#newTree'+id+'').jstree(tree);
      //$('#newTree'+id+'').jstree("refresh");
      //console.log('paso el try');
    }
    catch(err){
      //$('#newTree'+id+'').jstree("destroy");
      $('#newTree'+id+'').jstree(tree);
      //console.log('paso el catch');
      //console.log(err);
      //$('#newTree'+id+'').jstree(tree);
    }
    //console.log(tree);
    setTimeout(function(){
      var chapters=arbol["capitulos"];
      for (var i = 0; i < chapters.length; i++) {
        var topicos = chapters[i]["topico"];
        for (var j = 0; j < topicos.length; j++) {
          var subtopicos = topicos[j]["subtopico"];
          for (var k = 0; k < subtopicos.length; k++) {
            if (subtopicos[k]['id']==id){
              var vid = subtopicos[k]["videos"];
              for (var m = 0; m < vid.length; m++) {
                $('#newTree'+id+'').jstree('select_node', '#'+vid[m]['idtree']+'');
              }
            }
          }
        }
      }
    },500);
  }
  if (valor.value == "todos"){
    var tree = JSON.parse('{{ topictree_json_string | escapejs }}');
    var info = tree['core']['data'];
    try{
      $('#newTree'+id+'').jstree("destroy");
      $('#newTree'+id+'').jstree(tree);
    }
    catch(err){
      $('#newTree'+id+'').jstree(tree);
      console.log(err);
    }
    setTimeout(function(){
      var chapters=arbol["capitulos"];
      for (var i = 0; i < chapters.length; i++) {
        var topicos = chapters[i]["topico"];
        for (var j = 0; j < topicos.length; j++) {
          var subtopicos = topicos[j]["subtopico"];
          for (var k = 0; k < subtopicos.length; k++) {
            if (subtopicos[k]['id']==id){
              var ejer = subtopicos[k]["skills"];
              for (var l = 0; l < ejer.length; l++) {
                $('#newTree'+id+'').jstree('select_node', '#'+ejer[l]['idtree']+'');
              }
              var vid = subtopicos[k]["videos"];
              for (var m = 0; m < vid.length; m++) {
                $('#newTree'+id+'').jstree('select_node', '#'+vid[m]['idtree']+'');
              }
            }
          }
        }
      }
    },1000);    
  }
}

function deleteVideoExercise(id){
  $('#popup').empty();
  $('#hover').fadeIn();
  $('#popup').fadeIn();
  $('#popup').append('<div>¿Está seguro que desea eliminar los videos y ejercicios?</div>');
  $('#popup').append('<a onclick=\'(confirmDeleteVideoExercise("'+id+'"))\' class="kui-button kui-button-plain kui-button-primary" style="cursor:pointer; width:80px; height: 35px; padding:8px; margin-top:10px">Aceptar</a><a onclick="javascript:cancelDelete()" class="kui-button kui-button-plain kui-button-primary" style="display:inline;cursor:pointer; width:80px; height: 35px; padding:8px; margin-top:10px">Cancelar</a>')
}

function deleteSubtopic(id){
  $('#popup').empty();
  $('#hover').fadeIn();
  $('#popup').fadeIn();
  $('#popup').append('<div>¿Está seguro que desea eliminar el Objetivo de Aprendizaje? Perderá toda la información de videos y ejercicios asociados a él.</div>');
  $('#popup').append('<a onclick=\'(confirmDeleteSubtopic("'+id+'"))\' class="kui-button kui-button-plain kui-button-primary" style="cursor:pointer; width:80px; height: 35px; padding:8px; margin-top:10px">Aceptar</a><a onclick="javascript:cancelDelete()" class="kui-button kui-button-plain kui-button-primary" style="display:inline;cursor:pointer; width:80px; height: 35px; padding:8px; margin-top:10px">Cancelar</a>');
}

function deleteTopic(id){
  $('#popup').empty();
  $('#hover').fadeIn();
  $('#popup').fadeIn();
  $('#popup').append('<div>¿Está seguro que desea eliminar la unidad? Perderá toda la información de objetivos de aprendizaje, videos y ejercicios asociados a él.</div>');
  $('#popup').append('<a onclick=\'(confirmDeleteTopic("'+id+'"))\' class="kui-button kui-button-plain kui-button-primary" style="cursor:pointer; width:80px; height: 35px; padding:8px; margin-top:10px">Aceptar</a><a onclick="javascript:cancelDelete()" class="kui-button kui-button-plain kui-button-primary" style="display:inline;cursor:pointer; width:80px; height: 35px; padding:8px; margin-top:10px">Cancelar</a>');
}

function deleteChapter(id){
  $('#popup').empty();
  $('#hover').fadeIn();
  $('#popup').fadeIn();
  $('#popup').append('<div style="max-width:500px;margin-left:50px;">¿Está seguro que desea eliminar el nivel? Perderá toda la información de unidades, objetivos de aprendizaje, videos y ejercicios asociados a él.</div>');
  $('#popup').append('<a onclick=\'(confirmDeleteChapter("'+id+'"))\' class="kui-button kui-button-plain kui-button-primary" style="cursor:pointer; width:80px; height: 35px; padding:8px; margin-top:10px">Aceptar</a><a onclick="javascript:cancelDelete()" class="kui-button kui-button-plain kui-button-primary" style="display:inline;cursor:pointer; width:80px; height: 35px; padding:8px; margin-top:10px">Cancelar</a>');
}

function cancelDelete(){
  $('#popup').hide();
  $('#hover').hide();
}

function confirmDeleteVideoExercise(id){
  //console.log(id)
  $.ajax({
    url: "{% url 'curriculum:deletevideoexercise' %}",
    type: "POST",
    data: {idsubtopic:id},
      success: function(response){
        $("#popup").empty()
        $("#close").hide();
        $("#hover").fadeIn();
        $("#popup").fadeIn();
        $("#popup").append("<p class='response'>"+response+"</p>");
        auxResponse = response;
          if (auxResponse == "Videos y Ejercicios borrados correctamente"){
            $("#hover").css('pointer-events','none');
            $("#close").css('pointer-events','none');
            window.setTimeout(function(){location.reload()},1000);
          }
      }
  });
}

function confirmDeleteSubtopic(id){
  $.ajax({
    url: "{% url 'curriculum:deletesubtopic' %}",
    type: "POST",
    data: {idtopic: id},
      success: function(response){
        $('#popup').empty();
        $('#close').hide();
        $('#hover').fadeIn();
        $('#popup').fadeIn();
        $('#popup').append("<p class='response'>"+response+"</p>");
        auxResponse = response;
          if (auxResponse == "Objetivo de Aprendizaje borrado correctamente"){
            $("#hover").css('pointer-events', 'none');
            $('#close').css('pointer-events', 'none');
            window.setTimeout(function(){location.reload()}, 1000);
          }
      }
  });
}

function confirmDeleteTopic(id){
  $.ajax({
    url: "{% url 'curriculum:deletetopic' %}",
    type: "POST",
    data: {idchapter: id},
      success: function(response){
        $('#popup').empty();
        $('#close').hide();
        $('#hover').fadeIn();
        $('#popup').fadeIn();
        $('#popup').append("<p class='response'>"+response+"</p>");
        auxResponse = response;
          if (auxResponse == "Unidad borrada correctamente"){
            $("#hover").css('pointer-events', 'none');
            $('#close').css('pointer-events', 'none');
            window.setTimeout(function(){location.reload()}, 1000);
          }
      }
  });
}

function confirmDeleteChapter(id){
  $.ajax({
    url: "{% url 'curriculum:deletechapter' %}",
    type: "POST",
    data: {idchapter: id},
      success: function(response){
        $('#popup').empty();
        $('#close').hide();
        $('#hover').fadeIn();
        $('#popup').fadeIn();
        $('#popup').append("<p class='response'>"+response+"</p>");
        auxResponse = response;
          if (auxResponse == "Nivel borrado correctamente"){
            $("#hover").css('pointer-events', 'none');
            $('#close').css('pointer-events', 'none');
            window.setTimeout(function(){location.reload()}, 1000);
          }
      }
  });
}

function validar(){
  flag = true;
  nName = document.getElementById("newName").value;
  if(nName == null || nName.length == 0 || /^\s+$/.test(nName)) {
    $("#newName").css('color', '#C30202');
    flag = false;
  }else{
    $("#newName").css('color', '#000000');
  }
  return flag;
}

function validarTopic(){
  flag = true;
  nName = document.getElementById("newNameTopic").value;
  if(nName == null || nName.length == 0 || /^\s+$/.test(nName)) {
    $("#newNameTopic").css('color', '#C30202');
    flag = false;
  }else{
    $("#newNameTopic").css('color', '#000000');
  }
  return flag;
}

function validarSubtopic(){
  flag = true;
  nName = document.getElementById("newNameSubtopic").value;
  if(nName == null || nName.length == 0 || /^\s+$/.test(nName)) {
    $("#newNameSubtopic").css('color', '#C30202');
    flag = false;
  }else{
    $("#newNameSubtopic").css('color', '#000000');
  }
  return flag;
}
</script>

{% endblock %}